<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>çŸ­è·‘æ¸¬è©¦å·¥å…·</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background: #111;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    button {
      font-size: 18px;
      padding: 14px 28px;
      margin: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .primary {
      background: #00c853;
      color: #000;
    }
    .danger {
      background: #ff5252;
      color: #000;
    }
    input {
      font-size: 18px;
      padding: 10px;
      width: 200px;
      text-align: center;
    }
    .section {
      margin-top: 30px;
    }
    #stopBtn {
      width: 92vw;
      max-width: 520px;
      font-size: 28px;
      padding: 22px 18px;
      border-radius: 14px;
    }
    #lapBtn {
      width: 92vw;
      max-width: 520px;
      font-size: 20px;
      padding: 14px 18px;
      border-radius: 14px;
    }
  </style>
</head>

<body>

  <h1>ğŸƒ çŸ­è·‘æ¸¬è©¦</h1>

  <!-- é…å°å€ -->
  <div class="section" id="pairSection">
    <p>é…å°ä»£ç¢¼</p>
    <input id="roomInput" placeholder="è¼¸å…¥æˆ–ç”¢ç”Ÿä»£ç¢¼" />
    <br />
    <button class="primary" id="createRoom">ç”¢ç”Ÿä»£ç¢¼</button>
    <button class="primary" id="joinRoom">åŠ å…¥</button>
  </div>

  <!-- è§’è‰²é¸æ“‡ -->
  <div class="section" id="roleSection" style="display:none;">
    <p>è¨­å®šæœ¬æ¬¡è·é›¢ï¼ˆå…¬å°ºï¼‰</p>
    <input id="distanceInput" type="number" min="1" step="1" value="100" style="width:220px;" />
    <p style="opacity:.8; margin-top:8px;">ï¼ˆç¬¬ä¸€æ¬¡è¨­å®šæœƒå¯«å…¥æˆ¿é–“ï¼Œå¦ä¸€å°æœƒè‡ªå‹•åŒæ­¥ï¼‰</p>

    <hr style="opacity:.2; margin:18px 0;" />

    <p>è§’è‰²åˆ†é…</p>
    <p id="roleHint" style="opacity:.85;">è«‹å…ˆç”±å…¶ä¸­ä¸€å°é¸æ“‡è§’è‰²ï¼Œå¦ä¸€å°æœƒè‡ªå‹•åˆ†é…åˆ°å¦ä¸€å€‹è§’è‰²ã€‚</p>
    <button class="primary" id="startRole">é¸æ“‡ï¼šèµ·è·‘ç«¯</button>
    <button class="primary" id="finishRole">é¸æ“‡ï¼šçµ‚é»ç«¯</button>
    <br/>
    <button class="primary" id="reselectRoleBtn">é‡æ–°é¸æ“‡èº«åˆ†</button>
    <button class="primary" id="resetRunBtn">é‡æ–°æ¸¬è©¦</button>
  </div>

  <!-- èµ·è·‘ç«¯ -->
  <div class="section" id="startSection" style="display:none;">
    <h2>èµ·è·‘ç«¯</h2>
    <button class="primary" id="readyBtn">READY â†’ SET â†’ ğŸŸ¢</button>
    <p id="liveTimeStart" style="font-size:28px; margin-top:14px;">0.00 s</p>
    <p id="netInfoStart" style="opacity:.85;">å»¶é²/åç§»ï¼š-- ms</p>
  </div>

  <!-- çµ‚é»ç«¯ -->
  <div class="section" id="finishSection" style="display:none;">
    <h2>çµ‚é»ç«¯</h2>
    <button class="danger" id="stopBtn">åˆ°é”çµ‚é»</button>
    <button class="primary" id="lapBtn">åˆ†åœˆï¼ˆLapï¼‰</button>

    <p id="liveTimeFinish" style="font-size:28px; margin-top:14px;">0.00 s</p>
    <p id="netInfoFinish" style="opacity:.85;">å»¶é²/åç§»ï¼š-- ms</p>

    <p id="result"></p>
    <div id="lapsBox" style="max-width:420px; margin:12px auto; text-align:left;"></div>
  </div>

  <!-- å“¨éŸ³ç§»é™¤ï¼Œæ”¹ç”¨ Web Audio åœ¨è…³æœ¬ä¸­ç”¢ç”Ÿ -->

  <!-- Firebase CDNï¼ˆä¸€å®šè¦ç”¨ compatï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    /***********************
     * Firebase è¨­å®šï¼ˆä½ çš„ï¼‰
     ***********************/
    const firebaseConfig = {
      apiKey: "AIzaSyALxLJ1Jq4OYGLHcUhXouQnluobschD8-Q",
      authDomain: "speedtest-1a8bf.firebaseapp.com",
      databaseURL: "https://speedtest-1a8bf-default-rtdb.firebaseio.com",
      projectId: "speedtest-1a8bf",
      storageBucket: "speedtest-1a8bf.firebasestorage.app",
      messagingSenderId: "291894125118",
      appId: "1:291894125118:web:dd3433e2ba88ed6223a76f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /***********************
     * å…¨åŸŸç‹€æ…‹
     ***********************/
    let roomId = "";
    let role = "";

    // æ¯å€‹è£ç½®/ç€è¦½å™¨ä¸€å€‹å›ºå®š IDï¼Œç”¨ä¾†æ¨™è¨˜åƒèˆ‡è€…
    const clientId = (() => {
    const key = "speedtest_client_id";
    let v = localStorage.getItem(key);
    if (!v) {
        v = Math.random().toString(36).slice(2) + "_" + Date.now().toString(36);
        localStorage.setItem(key, v);
    }
    return v;
    })();

    const roomInput = document.getElementById("roomInput");
    const pairSection = document.getElementById("pairSection");
    const roleSection = document.getElementById("roleSection");
    const startSection = document.getElementById("startSection");
    const finishSection = document.getElementById("finishSection");
    const distanceInput = document.getElementById("distanceInput");
    const roleHint = document.getElementById("roleHint");

    // é¡¯ç¤ºç‹€æ…‹ç”¨ï¼ˆåŠ åœ¨é…å°å€ä¸‹æ–¹ï¼‰
    let statusEl = document.getElementById("status");
    if (!statusEl) {
    statusEl = document.createElement("p");
    statusEl.id = "status";
    statusEl.style.opacity = "0.9";
    statusEl.style.marginTop = "12px";
    pairSection.appendChild(statusEl);
    }
    function setStatus(msg) {
    statusEl.textContent = msg || "";
    }

    // æ§åˆ¶ç•«é¢åˆ‡æ›
    function show(section) {
    pairSection.style.display = "none";
    roleSection.style.display = "none";
    startSection.style.display = "none";
    finishSection.style.display = "none";
    section.style.display = "block";
    }

    /***********************
     * é…å°
     ***********************/
    document.getElementById("createRoom").onclick = async () => {
    roomId = Math.random().toString(36).substring(2, 7).toUpperCase();
    roomInput.value = roomId;

    // 1) åœ¨ Firebase å»ºç«‹æˆ¿é–“ï¼ˆé€™æ˜¯ bug çš„æ ¹æœ¬åŸå› ï¼‰
    await db.ref(`rooms/${roomId}`).set({
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        hostId: clientId
    });

    // 2) æŠŠè‡ªå·±åŠ å…¥ participantsï¼Œä¸¦è¨­å®šé›¢ç·šè‡ªå‹•æ¸…é™¤ï¼ˆå¯é¸ä½†å»ºè­°ï¼‰
    const meRef = db.ref(`rooms/${roomId}/participants/${clientId}`);
    await meRef.set({
        joinedAt: firebase.database.ServerValue.TIMESTAMP
    });
    meRef.onDisconnect().remove();

    setStatus(`ä»£ç¢¼å·²å»ºç«‹ï¼š${roomId}ï¼ˆç­‰å¾…å¦ä¸€å°åŠ å…¥â€¦ï¼‰`);

    // 3) é›»è…¦ç«¯é–‹å§‹ç›£è½ã€Œæ˜¯å¦æœ‰äººåŠ å…¥ã€ï¼Œä¸€æ—¦æœ‰äººåŠ å…¥å°±è‡ªå‹•é€²ä¸‹ä¸€æ­¥ï¼ˆè§£ Bug1ï¼‰
    watchParticipantsAndAutoAdvance();
    };

    document.getElementById("joinRoom").onclick = async () => {
    roomId = roomInput.value.trim().toUpperCase();
    if (!roomId) return alert("è«‹è¼¸å…¥ä»£ç¢¼");

    // 1) å…ˆæª¢æŸ¥æˆ¿é–“æ˜¯å¦å­˜åœ¨ï¼ˆä¸å­˜åœ¨å°±ä¸æ”¾è¡Œï¼‰
    const roomSnap = await db.ref(`rooms/${roomId}/createdAt`).get();
    if (!roomSnap.exists()) {
        setStatus(`æ‰¾ä¸åˆ°ä»£ç¢¼ï¼š${roomId}ï¼ˆè«‹ç¢ºèªå°æ–¹å·²å»ºç«‹ä»£ç¢¼ï¼‰`);
        alert("ä»£ç¢¼ä¸å­˜åœ¨æˆ–å°šæœªå»ºç«‹ï¼Œè«‹é‡æ–°ç¢ºèªã€‚");
        return;
    }

    // 2) æˆ¿é–“å­˜åœ¨ â†’ æŠŠè‡ªå·±å¯«å…¥ participants
    const meRef = db.ref(`rooms/${roomId}/participants/${clientId}`);
    await meRef.set({
        joinedAt: firebase.database.ServerValue.TIMESTAMP
    });
    meRef.onDisconnect().remove();

    setStatus(`å·²åŠ å…¥æˆ¿é–“ï¼š${roomId}`);

    // 3) åŠ å…¥è€…å¯ç›´æ¥é€²è§’è‰²é¸æ“‡
    show(roleSection);

    // 4) åŒæ™‚ä¹Ÿç›£è½äººæ•¸ï¼ˆå¦‚æœå°æ–¹é‚„æ²’æº–å‚™å¥½ï¼Œä¹Ÿèƒ½åŒæ­¥ç‹€æ…‹ï¼‰
    watchParticipantsAndAutoAdvance();
    };

    /***********************
     * è§’è‰²åˆ†é…èˆ‡è·é›¢åŒæ­¥ç”±ç›£è½å‡½å¼è™•ç†ï¼ˆwatchRoleAssignment / watchDistanceï¼‰
     ***********************/

    /***********************
     * èµ·è·‘ç«¯ï¼ˆWeb Audio å—¶è² + ä»¥ä¼ºæœå™¨æ™‚é–“ç‚ºåŸºæº–ï¼‰
     ***********************/
    let audioCtx = null;
    function beep(freq = 600, durationMs = 120) {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.9, audioCtx.currentTime + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + durationMs / 1000);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + durationMs / 1000 + 0.02);
    }

    document.getElementById("readyBtn").onclick = async () => {
      // ç¢ºä¿éŸ³è¨Šå¯æ’­æ”¾ï¼ˆè¡Œå‹•è£ç½®å¸¸è¦‹ suspended ç‹€æ…‹ï¼‰
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === "suspended") await audioCtx.resume();
      // æº–å‚™ / é å‚™ï¼ˆä½éŸ³ï¼‰
      beep(520, 120);
      await new Promise(r => setTimeout(r, 700));
      beep(520, 120);
      await new Promise(r => setTimeout(r, 700));
      // èµ·è·‘ï¼ˆé«˜éŸ³ï¼‰
      beep(980, 240);
      // ä»¥ä¼ºæœå™¨æ™‚é–“è¨­ç½®èµ·è·‘æ™‚é–“
      db.ref(`rooms/${roomId}/startTime`).set(firebase.database.ServerValue.TIMESTAMP);
    };

    /***********************
     * çµ‚é»ç«¯ï¼ˆLap èˆ‡åˆ°é”çµ‚é»ï¼‰
     ***********************/
    let serverOffsetMs = 0;
    let liveTimer = null;

    document.getElementById("lapBtn").onclick = async () => {
      const snap = await db.ref(`rooms/${roomId}/startTime`).get();
      if (!snap.exists()) return alert("å°šæœªèµ·è·‘");
      const startTime = snap.val();
      const serverNow = Date.now() + serverOffsetMs;
      const elapsed = (serverNow - startTime) / 1000;
      const dSnap = await db.ref(`rooms/${roomId}/distance`).get();
      const dist = dSnap.exists() ? Number(dSnap.val()) : 100;
      const speed = dist / elapsed; // m/s
      const lapRef = db.ref(`rooms/${roomId}/laps`).push();
      await lapRef.set({ elapsed: Number(elapsed.toFixed(2)), speed: Number(speed.toFixed(2)), serverNow: Math.round(serverNow) });
    };

    document.getElementById("stopBtn").onclick = async () => {
      const snap = await db.ref(`rooms/${roomId}/startTime`).get();
      if (!snap.exists()) return alert("å°šæœªèµ·è·‘");
      const startTime = snap.val();
      const serverNow = Date.now() + serverOffsetMs;
      const elapsed = (serverNow - startTime) / 1000;
      const distSnap = await db.ref(`rooms/${roomId}/distance`).get();
      const distance = distSnap.exists() ? Number(distSnap.val()) : 100;
      const speed = (distance / elapsed).toFixed(2);
      await db.ref(`rooms/${roomId}/finishTime`).set(Math.round(serverNow));
      document.getElementById("result").innerText =
        `â± ${elapsed.toFixed(2)} ç§’\nğŸš€ ${speed} m/sï¼ˆè·é›¢ ${distance} mï¼‰`;
      document.getElementById("stopBtn").disabled = true;
      document.getElementById("lapBtn").disabled = true;
      if (liveTimer) { clearInterval(liveTimer); liveTimer = null; }
    };

    function watchServerOffset() {
      db.ref(".info/serverTimeOffset").on("value", (snap) => {
        serverOffsetMs = snap.val() || 0;
        const n1 = document.getElementById("netInfoStart");
        const n2 = document.getElementById("netInfoFinish");
        if (n1) n1.textContent = `å»¶é²/åç§»ï¼š${Math.round(serverOffsetMs)} ms`;
        if (n2) n2.textContent = `å»¶é²/åç§»ï¼š${Math.round(serverOffsetMs)} ms`;
      });
    }

    function startLiveClock() {
      if (!roomId) return;
      const startRef = db.ref(`rooms/${roomId}/startTime`);
      startRef.on("value", (snap) => {
        const t0 = snap.val();
        if (!t0) return;
        if (liveTimer) clearInterval(liveTimer);
        liveTimer = setInterval(() => {
          const serverNow = Date.now() + serverOffsetMs;
          const elapsed = (serverNow - t0) / 1000;
          const s1 = document.getElementById("liveTimeStart");
          const s2 = document.getElementById("liveTimeFinish");
          if (s1) s1.textContent = `${elapsed.toFixed(2)} s`;
          if (s2) s2.textContent = `${elapsed.toFixed(2)} s`;
        }, 50);
      });
    }

    function renderLaps(laps) {
      const box = document.getElementById("lapsBox");
      if (!box) return;
      const arr = laps ? Object.values(laps) : [];
      if (arr.length === 0) { box.innerHTML = ""; return; }
      box.innerHTML = arr
        .sort((a,b) => (a.serverNow||0) - (b.serverNow||0))
        .map((x, i) => `#${i+1}ã€€${Number(x.elapsed||0).toFixed(2)} sã€€(${Number(x.speed||0).toFixed(2)} m/s)`)
        .join("<br/>");
    }

    // é‡æ–°æ¸¬è©¦ï¼šæ¸…ç©ºè·‘æ­¥è³‡æ–™ä½†ä¿ç•™ participants
    async function resetRun() {
      if (!roomId) return;
      await db.ref(`rooms/${roomId}/startTime`).remove();
      await db.ref(`rooms/${roomId}/finishTime`).remove();
      await db.ref(`rooms/${roomId}/laps`).remove();
      await db.ref(`rooms/${roomId}/roles`).remove();
      document.getElementById("result").innerText = "";
      const box = document.getElementById("lapsBox"); if (box) box.innerHTML = "";
      document.getElementById("stopBtn").disabled = false;
      document.getElementById("lapBtn").disabled = false;
      if (liveTimer) { clearInterval(liveTimer); liveTimer = null; }
      show(roleSection);
    }
    document.getElementById("resetRunBtn").onclick = resetRun;

    // é‡æ–°é¸æ“‡èº«åˆ†ï¼šæ¸…ç©º roles è®“å…©ç«¯å›åˆ°è§’è‰²é¸æ“‡
    document.getElementById("reselectRoleBtn").onclick = async () => {
      if (!roomId) return;
      await db.ref(`rooms/${roomId}/roles`).remove();
    };

    // ç›£è½ resetï¼ˆroles è¢«ç§»é™¤è¦–ç‚ºé‡æ–°æ¸¬è©¦åˆ‡å›åˆå§‹ç‹€æ…‹ï¼‰
    function watchResetRun() {
      if (!roomId) return;
      db.ref(`rooms/${roomId}/roles`).on("value", (snap) => {
        if (!snap.exists()) {
          role = "";
          document.getElementById("result").innerText = "";
          const box = document.getElementById("lapsBox"); if (box) box.innerHTML = "";
          document.getElementById("stopBtn").disabled = false;
          document.getElementById("lapBtn").disabled = false;
          if (liveTimer) { clearInterval(liveTimer); liveTimer = null; }
          show(roleSection);
        }
      });
    }

    // ç›£è½ finishTimeï¼Œè‹¥å·²å­˜åœ¨å°±åœæ­¢ live è¨ˆæ™‚ï¼ˆå…©ç«¯åŒæ­¥ï¼‰
    function watchFinishStop() {
      if (!roomId) return;
      db.ref(`rooms/${roomId}/finishTime`).on("value", (snap) => {
        if (snap.exists()) {
          if (liveTimer) { clearInterval(liveTimer); liveTimer = null; }
        }
      });
    }

    function watchLaps() {
      if (!roomId) return;
      db.ref(`rooms/${roomId}/laps`).on("value", (snap) => renderLaps(snap.val()));
    }

    function watchDistance() {
      if (!roomId) return;
      const distRef = db.ref(`rooms/${roomId}/distance`);
      // DB -> UI
      distRef.on("value", (snap) => {
        const v = snap.val();
        if (v && Number.isFinite(v)) {
          distanceInput.value = v;
        }
      });
      // UI -> DBï¼ˆç¬¬ä¸€æ¬¡è¨­å®šæ‰å¯«å…¥ï¼›å·²å­˜åœ¨å°±ä¸è¦†è“‹ï¼‰
      distanceInput.addEventListener("change", async () => {
        const v = Number(distanceInput.value);
        if (!v || v <= 0) { alert("è·é›¢éœ€ç‚ºæ­£æ•´æ•¸"); return; }
        const cur = await distRef.get();
        if (!cur.exists()) {
          await distRef.set(Math.round(v));
          setStatus(`è·é›¢å·²è¨­å®šç‚º ${Math.round(v)} m`);
        } else {
          setStatus(`è·é›¢å·²å­˜åœ¨ï¼ˆ${cur.val()} mï¼‰ï¼Œä¸è¦†è“‹`);
          distanceInput.value = cur.val();
        }
      }, { once: false });
    }

    function watchRoleAssignment() {
      if (!roomId) return;
      const startRef = db.ref(`rooms/${roomId}/roles/start`);
      const finishRef = db.ref(`rooms/${roomId}/roles/finish`);

      function applyRoleUI(newRole) {
        role = newRole;
        if (newRole === "start") {
          show(startSection);
        } else if (newRole === "finish") {
          show(finishSection);
        }
      }

      db.ref(`rooms/${roomId}/roles`).on("value", (snap) => {
        const roles = snap.val() || {};
        const s = roles.start || null;
        const f = roles.finish || null;
        if (s === clientId) applyRoleUI("start");
        if (f === clientId) applyRoleUI("finish");
        if (s && f) {
          roleHint.textContent = "âœ… è§’è‰²å·²åˆ†é…å®Œæˆ";
          document.getElementById("startRole").disabled = true;
          document.getElementById("finishRole").disabled = true;
        } else {
          roleHint.textContent = "è«‹å…ˆç”±å…¶ä¸­ä¸€å°é¸æ“‡è§’è‰²ï¼Œå¦ä¸€å°æœƒè‡ªå‹•åˆ†é…åˆ°å¦ä¸€å€‹è§’è‰²ã€‚";
        }
      });

      document.getElementById("startRole").onclick = async () => {
        const s = await startRef.get();
        if (s.exists() && s.val() !== clientId) { alert("èµ·è·‘ç«¯å·²è¢«å¦ä¸€å°é¸èµ°"); return; }
        await startRef.set(clientId);
        autoAssignOtherRole();
      };
      document.getElementById("finishRole").onclick = async () => {
        const f = await finishRef.get();
        if (f.exists() && f.val() !== clientId) { alert("çµ‚é»ç«¯å·²è¢«å¦ä¸€å°é¸èµ°"); return; }
        await finishRef.set(clientId);
        autoAssignOtherRole();
      };

      async function autoAssignOtherRole() {
        const partSnap = await db.ref(`rooms/${roomId}/participants`).get();
        const participants = partSnap.val() || {};
        const ids = Object.keys(participants);
        if (ids.length < 2) return;
        const otherId = ids.find(id => id !== clientId);
        if (!otherId) return;
        const rolesSnap = await db.ref(`rooms/${roomId}/roles`).get();
        const roles = rolesSnap.val() || {};
        if (!roles.start) await startRef.set(otherId);
        else if (!roles.finish) await finishRef.set(otherId);
      }
    }

    function watchParticipantsAndAutoAdvance() {
      if (!roomId) return;
      db.ref(`rooms/${roomId}/participants`).on("value", (snap) => {
        const participants = snap.val() || {};
        const count = Object.keys(participants).length;
        setStatus(`æˆ¿é–“ ${roomId} é€£ç·šäººæ•¸ï¼š${count}`);
        if (count >= 2) {
          show(roleSection);
          // å…©ç«¯é€²å…¥ç›£è½ï¼šæ™‚é–“åç§»ã€å³æ™‚ç§’æ•¸ã€è·é›¢ã€è§’è‰²ã€åˆ†åœˆ
          watchServerOffset();
          startLiveClock();
          watchDistance();
          watchRoleAssignment();
          watchLaps();
          watchResetRun();
          watchFinishStop();
        }
      });
    }

  </script>

</body>
</html>
