<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>100 å…¬å°ºçŸ­è·‘æ¸¬é€Ÿå·¥å…·</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background: #111;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    button {
      font-size: 18px;
      padding: 14px 28px;
      margin: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .primary {
      background: #00c853;
      color: #000;
    }
    .danger {
      background: #ff5252;
      color: #000;
    }
    input {
      font-size: 18px;
      padding: 10px;
      width: 200px;
      text-align: center;
    }
    .section {
      margin-top: 30px;
    }
  </style>
</head>

<body>

  <h1>ğŸƒ 100 å…¬å°ºçŸ­è·‘æ¸¬é€Ÿ</h1>

  <!-- é…å°å€ -->
  <div class="section" id="pairSection">
    <p>é…å°ä»£ç¢¼</p>
    <input id="roomInput" placeholder="è¼¸å…¥æˆ–ç”¢ç”Ÿä»£ç¢¼" />
    <br />
    <button class="primary" id="createRoom">ç”¢ç”Ÿä»£ç¢¼</button>
    <button class="primary" id="joinRoom">åŠ å…¥</button>
  </div>

  <!-- è§’è‰²é¸æ“‡ -->
  <div class="section" id="roleSection" style="display:none;">
    <p>é¸æ“‡è§’è‰²</p>
    <button class="primary" id="startRole">èµ·è·‘ç«¯</button>
    <button class="primary" id="finishRole">çµ‚é»ç«¯</button>
  </div>

  <!-- èµ·è·‘ç«¯ -->
  <div class="section" id="startSection" style="display:none;">
    <h2>èµ·è·‘ç«¯</h2>
    <button class="primary" id="readyBtn">READY â†’ SET â†’ ğŸŸ¢</button>
  </div>

  <!-- çµ‚é»ç«¯ -->
  <div class="section" id="finishSection" style="display:none;">
    <h2>çµ‚é»ç«¯</h2>
    <button class="danger" id="stopBtn">åˆ°é”çµ‚é»</button>
    <p id="result"></p>
  </div>

  <!-- å“¨éŸ³ -->
  <audio id="beepSound">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
  </audio>

  <!-- Firebase CDNï¼ˆä¸€å®šè¦ç”¨ compatï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    /***********************
     * Firebase è¨­å®šï¼ˆä½ çš„ï¼‰
     ***********************/
    const firebaseConfig = {
      apiKey: "AIzaSyALxLJ1Jq4OYGLHcUhXouQnluobschD8-Q",
      authDomain: "speedtest-1a8bf.firebaseapp.com",
      databaseURL: "https://speedtest-1a8bf-default-rtdb.firebaseio.com",
      projectId: "speedtest-1a8bf",
      storageBucket: "speedtest-1a8bf.firebasestorage.app",
      messagingSenderId: "291894125118",
      appId: "1:291894125118:web:dd3433e2ba88ed6223a76f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /***********************
     * å…¨åŸŸç‹€æ…‹
     ***********************/
    let roomId = "";
    let role = "";

    // æ¯å€‹è£ç½®/ç€è¦½å™¨ä¸€å€‹å›ºå®š IDï¼Œç”¨ä¾†æ¨™è¨˜åƒèˆ‡è€…
    const clientId = (() => {
    const key = "speedtest_client_id";
    let v = localStorage.getItem(key);
    if (!v) {
        v = Math.random().toString(36).slice(2) + "_" + Date.now().toString(36);
        localStorage.setItem(key, v);
    }
    return v;
    })();

    const roomInput = document.getElementById("roomInput");
    const pairSection = document.getElementById("pairSection");
    const roleSection = document.getElementById("roleSection");
    const startSection = document.getElementById("startSection");
    const finishSection = document.getElementById("finishSection");

    // é¡¯ç¤ºç‹€æ…‹ç”¨ï¼ˆåŠ åœ¨é…å°å€ä¸‹æ–¹ï¼‰
    let statusEl = document.getElementById("status");
    if (!statusEl) {
    statusEl = document.createElement("p");
    statusEl.id = "status";
    statusEl.style.opacity = "0.9";
    statusEl.style.marginTop = "12px";
    pairSection.appendChild(statusEl);
    }
    function setStatus(msg) {
    statusEl.textContent = msg || "";
    }

    // æ§åˆ¶ç•«é¢åˆ‡æ›
    function show(section) {
    pairSection.style.display = "none";
    roleSection.style.display = "none";
    startSection.style.display = "none";
    finishSection.style.display = "none";
    section.style.display = "block";
    }

    /***********************
     * é…å°
     ***********************/
    document.getElementById("createRoom").onclick = async () => {
    roomId = Math.random().toString(36).substring(2, 7).toUpperCase();
    roomInput.value = roomId;

    // 1) åœ¨ Firebase å»ºç«‹æˆ¿é–“ï¼ˆé€™æ˜¯ bug çš„æ ¹æœ¬åŸå› ï¼‰
    await db.ref(`rooms/${roomId}`).set({
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        hostId: clientId
    });

    // 2) æŠŠè‡ªå·±åŠ å…¥ participantsï¼Œä¸¦è¨­å®šé›¢ç·šè‡ªå‹•æ¸…é™¤ï¼ˆå¯é¸ä½†å»ºè­°ï¼‰
    const meRef = db.ref(`rooms/${roomId}/participants/${clientId}`);
    await meRef.set({
        joinedAt: firebase.database.ServerValue.TIMESTAMP
    });
    meRef.onDisconnect().remove();

    setStatus(`ä»£ç¢¼å·²å»ºç«‹ï¼š${roomId}ï¼ˆç­‰å¾…å¦ä¸€å°åŠ å…¥â€¦ï¼‰`);

    // 3) é›»è…¦ç«¯é–‹å§‹ç›£è½ã€Œæ˜¯å¦æœ‰äººåŠ å…¥ã€ï¼Œä¸€æ—¦æœ‰äººåŠ å…¥å°±è‡ªå‹•é€²ä¸‹ä¸€æ­¥ï¼ˆè§£ Bug1ï¼‰
    watchParticipantsAndAutoAdvance();
    };

    document.getElementById("joinRoom").onclick = async () => {
    roomId = roomInput.value.trim().toUpperCase();
    if (!roomId) return alert("è«‹è¼¸å…¥ä»£ç¢¼");

    // 1) å…ˆæª¢æŸ¥æˆ¿é–“æ˜¯å¦å­˜åœ¨ï¼ˆä¸å­˜åœ¨å°±ä¸æ”¾è¡Œï¼‰
    const roomSnap = await db.ref(`rooms/${roomId}/createdAt`).get();
    if (!roomSnap.exists()) {
        setStatus(`æ‰¾ä¸åˆ°ä»£ç¢¼ï¼š${roomId}ï¼ˆè«‹ç¢ºèªå°æ–¹å·²å»ºç«‹ä»£ç¢¼ï¼‰`);
        alert("ä»£ç¢¼ä¸å­˜åœ¨æˆ–å°šæœªå»ºç«‹ï¼Œè«‹é‡æ–°ç¢ºèªã€‚");
        return;
    }

    // 2) æˆ¿é–“å­˜åœ¨ â†’ æŠŠè‡ªå·±å¯«å…¥ participants
    const meRef = db.ref(`rooms/${roomId}/participants/${clientId}`);
    await meRef.set({
        joinedAt: firebase.database.ServerValue.TIMESTAMP
    });
    meRef.onDisconnect().remove();

    setStatus(`å·²åŠ å…¥æˆ¿é–“ï¼š${roomId}`);

    // 3) åŠ å…¥è€…å¯ç›´æ¥é€²è§’è‰²é¸æ“‡
    show(roleSection);

    // 4) åŒæ™‚ä¹Ÿç›£è½äººæ•¸ï¼ˆå¦‚æœå°æ–¹é‚„æ²’æº–å‚™å¥½ï¼Œä¹Ÿèƒ½åŒæ­¥ç‹€æ…‹ï¼‰
    watchParticipantsAndAutoAdvance();
    };

    /***********************
     * è§’è‰²é¸æ“‡
     ***********************/
    document.getElementById("startRole").onclick = () => {
      role = "start";
      document.getElementById("roleSection").style.display = "none";
      document.getElementById("startSection").style.display = "block";
    };

    document.getElementById("finishRole").onclick = () => {
      role = "finish";
      document.getElementById("roleSection").style.display = "none";
      document.getElementById("finishSection").style.display = "block";
    };

    /***********************
     * èµ·è·‘ç«¯
     ***********************/
    document.getElementById("readyBtn").onclick = async () => {
      await new Promise(r => setTimeout(r, 800));
      await new Promise(r => setTimeout(r, 800));
      document.getElementById("beepSound").play();

      db.ref(`rooms/${roomId}/startTime`).set(firebase.database.ServerValue.TIMESTAMP);
    };

    /***********************
     * çµ‚é»ç«¯
     ***********************/
    document.getElementById("stopBtn").onclick = async () => {
      const snap = await db.ref(`rooms/${roomId}/startTime`).get();
      if (!snap.exists()) return alert("å°šæœªèµ·è·‘");

      const startTime = snap.val();
      const finishTime = Date.now();
      const elapsed = (finishTime - startTime) / 1000;
      const speed = (100 / elapsed).toFixed(2);

      document.getElementById("result").innerText =
        `â± ${elapsed.toFixed(2)} ç§’\nğŸš€ ${speed} m/s`;
    };

    function watchParticipantsAndAutoAdvance() {
  if (!roomId) return;

  db.ref(`rooms/${roomId}/participants`).on("value", (snap) => {
    const participants = snap.val() || {};
    const count = Object.keys(participants).length;

    // é¡¯ç¤ºç‹€æ…‹ï¼ˆæ–¹ä¾¿ä½ æ¸¬ï¼‰
    setStatus(`æˆ¿é–“ ${roomId} é€£ç·šäººæ•¸ï¼š${count}`);

    // åªè¦åµæ¸¬åˆ° >=2 äººï¼Œå°±è‡ªå‹•é€²å…¥è§’è‰²é¸æ“‡ï¼ˆé›»è…¦ç«¯å°±æœƒè‡ªå‹•è·³ï¼Œè§£ Bug1ï¼‰
    if (count >= 2) {
      show(roleSection);
    }
  });
}

  </script>

</body>
</html>
